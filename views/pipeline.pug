extends layout
block extrahead
  link(rel="stylesheet" href="stylesheets/jsoneditor.min.css")
  link(rel="stylesheet" href="stylesheets/pipeline.css")
  link(rel="stylesheet" href="stylesheets/highcharts.css")

  script(src="javascripts/jsoneditor.min.js" type="text/javascript")
  script(src="javascripts/pipeline.js" type="text/javascript")
  script(src="javascripts/highcharts-more.js" type="text/javascript")
  script(src="javascripts/sankey.js" type="text/javascript")
  script(src="javascripts/organization.js" type="text/javascript")
  //script(src="https://unpkg.com/@popperjs/core@2")
  script(src="javascripts/popper.min.js" type="text/javascript")

block content
  div.main-container
    .d-flex.flex-row
      .mr-auto.p-2
        button.btn.btn-primary.my-3(onclick="NewPipelineDropdown()")
          span
            | Add new &nbsp
            i.fas.fa-solid.fa-plus
            i.fas.fa-code-branch

      .p-2(style="margin-left:auto")
        .input-group.mb-3
          span.input-group-text.my-3
            i.fas.fa-solid.fa-magnifying-glass
          input.form-control.my-3#searchPipelineInput(type="text" onkeyup="PopulatePipelines()" placeholder="Search pipelines")
          button.btn.bg-transparent.my-3(type='button' style='margin-left: -40px; z-index: 100;' onclick='$("#searchPipelineInput").val(""); PopulatePipelines();')
            i.fa.fa-times
    h3 Active pipelines &nbsp;
      i.fas.fa-bell
    table.table.table-striped.table-hover
      thead
        tr
          th Name
          th Process time &nbsp
            i.fas.fa-solid.fa-circle-question(data-toggle="tooltip" data-placement="bottom"
              title="It takes of order 10ms to get a value from Influx. If the process time (given in ms) is" +
              " faster than this, something's not working, and there'll probably be new entries in the logs. " +
              " Pipelines only run as fast as the slowest sensor they depend on. If you want a faster pipeline," +
              " speed up the sensors.")
          th Latest cycle
          th Last error &nbsp
            i.fas.fa-solid.fa-circle-question(data-toggle="tooltip" data-placement="bottom"
              title="The internal buffers take a few cycles to fill, so there will always be \"errors\" shortly " +
              "after pipeline startup. As long as the error number is small and the cycle number isn't, it's fine")
          th Actions
      tbody#active_pipelines
        tr
          td(colspan=7) Loading!
    br
    h3 Silent pipelines &nbsp;
      i.fas.fa-bell-slash
    table.table.table-hover.table-striped
      thead
        tr
          th Name
          th Process time
          th Latest cycle
          th Last error
          th Actions
      tbody#silent_pipelines
        tr
          td(colspan=7) Loading!
    br
    h3 Inactive pipelines &nbsp;
      i.fas.fa-hand-paper
    table.table.table-hover.table-striped
      thead
        tr
          th Name
          th Start
      tbody#inactive_pipelines
        tr
          td(colspan=2) Loading!
    if load
      span#load_me(hidden)= load
    #silence_dropdown.modal.fade
      .modal-dialog.modal-sm
        .modal-content
          .modal-header
            h5.modal-title
              span
                |Silence
                #silence_me
            button.btn-close(type='button' data-bs-dismiss='modal' aria-label='Close')
          .modal-body
            .btn-group-vertical.d-flex.p-2
              button.btn.btn-primary.my-1(onclick="SilencePipeline(30)") 30 minutes
              button.btn.btn-primary.my-1(onclick="SilencePipeline(120)") 2 hours
              button.btn.btn-primary.my-1(onclick="SilencePipeline('evening')") 18:00 today
              button.btn.btn-primary.my-1(onclick="SilencePipeline('morning')") 09:30 tomorrow
              button.btn.btn-primary.my-1(onclick="SilencePipeline('monday')") Monday morning
              button.btn.btn-danger.my-1(onclick="SilencePipeline('forever')") The end of time
          .modal-footer
            button.btn.btn-secondary(type='button' data-bs-dismiss='modal') Cancel
  #pipelinebox.modal.fade
    .modal-dialog.modal-xl
      .modal-content
        .modal-header
          h5#pipelineboxLabel.modal-title
            span#detail_pipeline_name
          button.btn-close(type='button' data-bs-dismiss='modal' aria-label='Close')
        .modal-body.row
          .col-lg-6
            span See this wiki page for details: &nbsp;
              a(href="https://github.com/AG-Schumann/Doberman/wiki/Pipelines") here
            div#json_text
          .col-lg-6
            div#pipeline_vis
        .modal-footer
          button.btn.btn-secondary(type='button' data-bs-dismiss='modal') Close
          button.btn.btn-primary(type='button' onclick="AddOrUpdatePipeline()") Save changes


  script.
    $(document).ready(function() {
      document.jsoneditor = new JSONEditor(document.getElementById('json_text',
      {"modes":  ['tree', 'view', 'form', 'code', 'text']}));
      PopulatePipelines();
      setInterval(UpdateLoop, 5000);
      if ($("#load_me").html()) {
        PipelineDropdown($("#load_me").html());
      }
      $("#load_me").remove();
      $('[data-toggle="tooltip"]').tooltip()
    });
    $(function () {
      $('[data-toggle="tooltip"]').tooltip()
    })
