extends layout
block extrahead
  link(rel="stylesheet" href="stylesheets/jsoneditor.min.css")
  link(rel="stylesheet" href="stylesheets/pipeline.css")
  link(rel="stylesheet" href="stylesheets/highcharts.css")

  script(src="javascripts/jsoneditor.min.js" type="text/javascript")
  script(src="javascripts/pipeline.js" type="text/javascript")
  script(src="javascripts/highcharts-more.js" type="text/javascript")
  script(src="javascripts/sankey.js" type="text/javascript")
  script(src="javascripts/organization.js" type="text/javascript")

block content
  div.main-container.main-container-nav
    #navbar.navbar.fixed-top.navbar-light.bg-light
      .container-fluid
        .d-flex
          button.btn.btn-primary(onclick="NewPipelineDropdown()")
            span
              | Add new &nbsp
              i.fas.fa-solid.fa-plus
              i.fas.fa-code-branch
        .d-flex
          .input-group
            span.input-group-text
              i.fas.fa-solid.fa-magnifying-glass
            input.form-control#searchPipelineInput(type="text" onkeyup="PopulatePipelines()" placeholder="Search pipelines")
            button.btn.bg-transparent(type='button' style='margin-left: -40px; z-index: 100;' onclick='$("#searchPipelineInput").val(""); PopulatePipelines();')
              i.fa.fa-times
    h3 Active pipelines &nbsp;
      i.fas.fa-bell
    table.table.table-striped.table-hover
      thead
        tr
          th Name
          th Process time [ms] &nbsp
            i.fas.fa-solid.fa-circle-question(data-bs-toggle="tooltip" data-bs-html="true"
              title="It takes of order 10ms to get a value from Influx.<br><br>" +
              "If the process time is faster than this, something's not working, " +
              "and there'll probably be new entries in the logs.<br><br>" +
              "Pipelines only run as fast as the slowest sensor they depend on. " +
              "If you want a faster pipeline, speed up the sensors.")
          th Latest cycle
          th Last error &nbsp
            i.fas.fa-solid.fa-circle-question(data-bs-toggle="tooltip" data-bs-html="true"
              title="The internal buffers take a few cycles to fill, so there can be \"errors\" shortly " +
              "after pipeline startup.<br><br>As long as the error number is small and the cycle number isn't, it's fine")
          th Actions
      tbody#active_pipelines
        tr
          td(colspan=7) Loading!
    br
    h3 Silent pipelines &nbsp;
      i.fas.fa-bell-slash
    table.table.table-hover.table-striped
      thead
        tr
          th Name
          th Process time
          th Latest cycle
          th Last error
          th Actions
      tbody#silent_pipelines
        tr
          td(colspan=7) Loading!
    br
    h3 Inactive pipelines &nbsp;
      i.fas.fa-hand-paper
    table.table.table-hover.table-striped
      thead
        tr
          th Name
          th Start
      tbody#inactive_pipelines
        tr
          td(colspan=2) Loading!
    #silence_dropdown.modal.fade
      .modal-dialog.modal-sm
        .modal-content
          .modal-header
            h5.modal-title
              span
                |Silence
                #silence_me
            button.btn-close(type='button' data-bs-dismiss='modal' aria-label='Close')
          .modal-body
            .btn-group-vertical.d-flex.p-2
              button.btn.btn-primary.my-1(onclick="SilencePipeline(30)") 30 minutes
              button.btn.btn-primary.my-1(onclick="SilencePipeline(120)") 2 hours
              button.btn.btn-primary.my-1(onclick="SilencePipeline('evening')") 18:00 today
              button.btn.btn-primary.my-1(onclick="SilencePipeline('morning')") 09:30 tomorrow
              button.btn.btn-primary.my-1(onclick="SilencePipeline('monday')") Monday morning
              button.btn.btn-danger.my-1(onclick="SilencePipeline('forever')") The end of time
          .modal-footer
            button.btn.btn-secondary(type='button' data-bs-dismiss='modal') Cancel
  #pipelinebox.modal.fade
    .modal-dialog.modal-xl
      .modal-content
        .modal-header
          h5#pipelineboxLabel.modal-title
            span#detail_pipeline_name
          button.btn-close(type='button' data-bs-dismiss='modal' aria-label='Close')
        .modal-body.row
          .col-lg-8
            span See this wiki page for details: &nbsp;
              a(href="https://github.com/AG-Schumann/Doberman/wiki/Pipelines") here
            div#json_text
          .col-lg-4
            div#pipeline_vis
        .modal-footer.justify-content-between
          button.btn.btn-danger(type='button' onclick="DeletePipeline()") Delete
          .d-flex
            button.btn.btn-secondary.me-2(type='button' data-bs-dismiss='modal') Close
            button.btn.btn-primary(type='button' onclick="AddOrUpdatePipeline()") Save changes


  script.
    $(document).ready(function() {
      document.jsoneditor = new JSONEditor(document.getElementById('json_text'),
              {"modes": ['tree', 'view', 'form', 'code', 'text']});
      PopulatePipelines();
      setInterval(UpdateLoop, 5000);
      $('[data-bs-toggle="tooltip"]').tooltip();
      if (new URLSearchParams(window.location.search).has('pipeline_id')) {
        PipelineDropdown(new URLSearchParams(window.location.search).get('pipeline_id'));
      };
    });
